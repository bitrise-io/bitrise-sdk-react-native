---
format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - BITRISE_PROJECT_PATH: example-expo
  - EXPO_CLI_VERSION: latest

workflows:

  # Primary workflow for CI/CD
  primary:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - script@1:
        title: Install dependencies
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo
            npm install
    - script@1:
        title: Run Expo prebuild
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo
            npx expo prebuild --clean
    - script@1:
        title: Verify native configuration
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo

            # Verify iOS Info.plist has deployment key
            if [ -f "ios/bitriseSDKexpoexample/Info.plist" ]; then
              echo "✓ iOS Info.plist found"
              if grep -q "CodePushDeploymentKey" "ios/bitriseSDKexpoexample/Info.plist"; then
                echo "✓ iOS deployment key configured"
              else
                echo "✗ iOS deployment key NOT found in Info.plist"
                exit 1
              fi
            fi

            # Verify Android strings.xml has deployment key
            if [ -f "android/app/src/main/res/values/strings.xml" ]; then
              echo "✓ Android strings.xml found"
              if grep -q "CodePushDeploymentKey" "android/app/src/main/res/values/strings.xml"; then
                echo "✓ Android deployment key configured"
              else
                echo "✗ Android deployment key NOT found in strings.xml"
                exit 1
              fi
            fi

            echo "✓ Native configuration verified successfully"

  # iOS build workflow
  ios:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - script@1:
        title: Install dependencies
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo
            npm install
    - script@1:
        title: Run Expo prebuild
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo
            npx expo prebuild --platform ios --clean
    - xcode-build-for-simulator@0:
        inputs:
        - project_path: example-expo/ios/bitriseSDKexpoexample.xcworkspace
        - scheme: bitriseSDKexpoexample
        - simulator_device: iPhone 14
    - deploy-to-bitrise-io@2: {}

  # Android build workflow
  android:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - script@1:
        title: Install dependencies
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo
            npm install
    - script@1:
        title: Run Expo prebuild
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo
            npx expo prebuild --platform android --clean
    - android-build@1:
        inputs:
        - project_location: example-expo/android
        - module: app
        - variant: debug
    - deploy-to-bitrise-io@2: {}

  # EAS Build workflow
  eas-build:
    steps:
    - activate-ssh-key@4:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone@8: {}
    - script@1:
        title: Install dependencies
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            npm install -g eas-cli
            cd example-expo
            npm install
    - script@1:
        title: EAS Build
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            cd example-expo

            # Login to EAS (requires EXPO_TOKEN environment variable)
            eas build --profile preview --platform all --non-interactive
